name: Enum

on:
  push:
    branches: [main]

jobs:
  enum:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go 1.23
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y wget unzip jq git curl dnsutils
          # assetfinder
          go install github.com/tomnomnom/assetfinder@latest
          sudo mv ~/go/bin/assetfinder /usr/bin/ || true
          # subfinder
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          sudo mv ~/go/bin/subfinder /usr/bin/ || true
          # dnsx
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          sudo mv ~/go/bin/dnsx /usr/bin/ || true
          # nuclei
          LATEST_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/nuclei/releases/latest | jq -r '.tag_name')
          CLEAN_VERSION=${LATEST_VERSION#v}
          wget -q https://github.com/projectdiscovery/nuclei/releases/download/${LATEST_VERSION}/nuclei_${CLEAN_VERSION}_linux_amd64.zip
          unzip -o nuclei_${CLEAN_VERSION}_linux_amd64.zip
          sudo mv nuclei /usr/bin/ || true
          sudo chmod +x /usr/bin/nuclei || true
          rm -f nuclei_${CLEAN_VERSION}_linux_amd64.zip *.md || true

      - name: Run Enumeration & Scan
        env:
          DOMAINS: ${{ secrets.DOMAIN }}
        run: |
          set -euo pipefail
          mkdir -p results
          printf "%s\n" "$DOMAINS" | tr ' \t' '\n' | grep -v '^$' > /tmp/domains.txt
          DOMAIN_COUNT=$(wc -l < /tmp/domains.txt || echo 0)
          echo "[*] Domains to process: $DOMAIN_COUNT"

          while IFS= read -r TARGET || [ -n "$TARGET" ]; do
            TARGET=$(echo "$TARGET" | tr -d '\r')
            [ -z "$TARGET" ] && continue
            echo "=== Enumeration for: $TARGET ==="
            mkdir -p "results/$TARGET"

            # 1. Subdomain enum (subfinder → assetfinder fallback)
            echo "[*] Running subfinder for $TARGET..."
            subfinder -silent -d "$TARGET" > "results/$TARGET/subdomains.txt" || true

            if [ ! -s "results/$TARGET/subdomains.txt" ]; then
              echo "[*] subfinder empty, trying assetfinder..."
              assetfinder --subs-only "$TARGET" | sort -u > "results/$TARGET/subdomains.txt"
            fi

            if [ ! -s "results/$TARGET/subdomains.txt" ]; then
              echo "[!] No subdomains found for $TARGET"
              continue
            fi

            sort -u "results/$TARGET/subdomains.txt" -o "results/$TARGET/subdomains.txt"
            echo "[*] Found $(wc -l < results/$TARGET/subdomains.txt) subdomains"

            # 2. Check alive + IP
            echo "[*] Running dnsx for $TARGET..."
            dnsx -silent -a -resp -l "results/$TARGET/subdomains.txt" > "results/$TARGET/live.txt" || true

            if [ ! -s "results/$TARGET/live.txt" ]; then
              echo "[!] No alive subdomains for $TARGET"
              continue
            fi

            echo "[*] Found $(wc -l < results/$TARGET/live.txt) alive subdomains"

            # 3. Scan with nuclei
            #echo "[*] Running nuclei for $TARGET..."
            #nuclei -l "results/$TARGET/live.txt" \
            #  -target-as-hostname \
            #  -severity medium,high,critical,low,unknown \
            #  -c 50 \
            #  -timeout 10 \
            #  -rate-limit 100 \
            #  -o "results/$TARGET/nuclei.txt" || true

          done #< /tmp/domains.txt

      - name: Send Alert
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DOMAINS: ${{ secrets.DOMAIN }}
        run: |
          echo "$DOMAINS" | tr ' \t' '\n' | grep -v '^$' | while read -r TARGET; do
            [ -z "$TARGET" ] && continue
            if [ -s results/$TARGET/nuclei.txt ]; then
              declare -A SEV_EMOJI=(
                ["critical"]="🚨 Critical"
                ["high"]="🔴 High"
                ["medium"]="🟠 Medium"
                ["low"]="🟢 Low"
                ["unknown"]="❓ Unknown"
              )
              for sev in critical high medium low unknown; do
                grep -i "\[$sev\]" "results/$TARGET/nuclei.txt" | while IFS= read -r line; do
                  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                    -d chat_id="${TELEGRAM_CHAT_ID}" \
                    --data-urlencode "text=${SEV_EMOJI[$sev]} | $line"
                  sleep 0.5
                done
              done
            else
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d chat_id="${TELEGRAM_CHAT_ID}" \
                -d text="✅ Scan done for: $TARGET — No vulnerabilities found."
            fi
          done

      - name: Git & Push results
        if: always()
        env:
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
          USER_NAME: ${{ secrets.USER_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config --global user.email "${EMAIL_ADDRESS}"
          git config --global user.name "${USER_NAME}"
          git add results/ || true
          git commit -m "scans/results: $(date -u)" --no-verify || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git push origin HEAD:main || true
